# -*- mode: makefile -*-
#
# Mongoose IoT for POSIX

MAKEFLAGS += --warn-undefined-variables
.DEFAULT_GOAL := all

REPO_PATH ?= ../../..
COMMON_PATH = $(REPO_PATH)/common
SRC_PATH ?= ../../src
V7_PATH ?= ../../../v7
MONGOOSE_PATH ?= ../../../mongoose
BIN_DIR ?= ./bin
BUILD_DIR ?= ./.build
KRYPTON_PATH ?= $(REPO_PATH)/krypton
FROZEN_PATH ?= $(REPO_PATH)/frozen
OUTAPP ?= mongoose-iot
VERBOSE ?= 0
VPATH = $(SRC_PATH) $(V7_PATH) $(MONGOOSE_PATH) $(FROZEN_PATH) $(COMMON_PATH)
SSL ?= Krypton
DEBUG ?= 0
CC_WRAPPER ?=

# For FW_VERSION, COMMON_V7_FEATURES, MG_FEATURES_TINY
include $(REPO_PATH)/fw/common.mk

LDFLAGS ?=

V7_FEATURES ?= $(COMMON_V7_FEATURES) \
              -DV7_BUILD_PROFILE=3 -DV7_ENABLE__Memory__stats \
              -DV7_ENABLE_COMPACTING_GC \
              -DV7_ENABLE_FILE -DV7_MAIN -DV7_ALLOW_ARGLESS_MAIN \
              -DV7_ENABLE_ENTITY_IDS

MIOT_FEATURES = -DSJ_ENABLE_JS \
                -DSJ_ENABLE_ADC_API
MIOT_POSIX_FEATURES ?= -DSJ_PROMPT_DISABLE_ECHO
MONGOOSE_FEATURES = \
  -DMG_USE_READ_WRITE -DMG_ENABLE_THREADS -DMG_ENABLE_THREADS \
  -DMG_ENABLE_HTTP_STREAMING_MULTIPART -DMG_DISABLE_DAV

INCLUDES = $(REPO_PATH) $(SRC_PATH) $(BUILD_DIR)
APP_SRCS = $(notdir $(wildcard *.c)) v7.c sj_v7_ext.c sj_init.c sj_init_js.c \
           mongoose.c frozen.c sj_i2c_js.c sj_spi_js.c sj_mongoose.c \
           sj_ws_client_js.c sj_mqtt_js.c sj_gpio_js.c sj_adc_js.c \
           sj_prompt.c sj_timers_js.c sj_timers_mongoose.c sj_uart.c sj_http_js.c \
           sj_debug_js.c sj_pwm_js.c sj_wifi.c sj_wifi_js.c clubby_proto.c \
           sj_config.c sj_config_js.c sj_sys_config.c sj_sys_config_js.c \
           $(notdir $(SYS_CONFIG_C)) $(notdir $(SYS_RO_VARS_C)) \
           json_utils.c sj_clubby.c sj_clubby_js.c \
           sj_tcp_udp_js.c sj_utils.c sj_console.c sj_console_js.c

# inline causes crashes in the compacting GC
# TODO(mkm) figure out which functions are inline sensitive and annotate them
CFLAGS_EXTRA =
CFLAGS ?= -std=c99 -fno-inline -W -Wall -Werror -g -Wno-unused-function \
          -Wno-missing-field-initializers \
          -D_DEFAULT_SOURCE \
          -D_GNU_SOURCE \
          $(V7_FEATURES) \
          $(MIOT_FEATURES) $(MIOT_POSIX_FEATURES) \
          $(MONGOOSE_FEATURES) \
          -DFW_ARCHITECTURE=\"$(PLATFORM)\" \
          $(CFLAGS_EXTRA)

ifeq "$(DEBUG)" "1"
CFLAGS += -O0
else
CFLAGS += -O2
endif

include $(COMMON_PATH)/scripts/platform.mk

ifeq ($(OS),Windows_NT)
  PLATFORM="WIN"
else
  UNAME_S := $(shell uname -s)
  ifeq ($(UNAME_S),Linux)
    PLATFORM="LINUX"
  else
    PLATFORM="POSIX"
  endif
endif

ifeq "$(SSL)" "OpenSSL"
  MONGOOSE_FEATURES += -DMG_ENABLE_SSL
  ADD_LIBS += ssl crypto
  ifeq ($(PLATFORM), "WIN")
    ADD_LIBS += gdi32
  endif
endif

# Non Windows
ifneq ($(PLATFORM), "WIN")
  ADD_LIBS += m pthread
endif

# Linux
ifeq ($(PLATFORM), "LINUX")
  ADD_LIBS += rt
  MIOT_FEATURES += -DSJ_ENABLE_GPIO_API \
                   -DSJ_ENABLE_I2C_API \
                   -DSJ_ENABLE_SPI_API
endif

# Windows
ifeq ($(PLATFORM), "WIN")
  CFLAGS += -D_WIN32_WINNT=0x0500
  ADD_LIBS += ws2_32
endif

ifeq "$(SSL)" "Krypton"
INCLUDES += $(KRYPTON_PATH)
VPATH += $(KRYPTON_PATH)
APP_SRCS += krypton.c
CFLAGS += -DMG_ENABLE_SSL -DMG_DISABLE_PFS -DSSL_KRYPTON
endif

GC_CHECK ?=
ifeq ($(GC_CHECK),1)
CFLAGS += -fno-optimize-sibling-calls -fno-omit-frame-pointer -fno-inline -finstrument-functions -DV7_ENABLE_GC_CHECK
endif

ASAN ?=
ifeq ($(ASAN),1)
  CFLAGS += -fsanitize=address -fcolor-diagnostics -fno-common
  LDFLAGS += -fsanitize=address
  CC = $(CLANG)
endif

INCDIRS = $(addprefix -I,$(INCLUDES))
LIBS = $(addprefix -l,$(ADD_LIBS))

APP_OBJS = $(patsubst %.c,$(BUILD_DIR)/%.o,$(APP_SRCS))
SYS_CONFIG_C = $(BUILD_DIR)/sys_config.c
SYS_RO_VARS_C = $(BUILD_DIR)/sys_ro_vars.c
BUILD_INFO_C = $(BUILD_DIR)/build_info.c
OBJS = $(APP_OBJS) $(BUILD_DIR)/build_info.o
GENFILES_FLAG = $(BUILD_DIR)/genfiles.done
GENFILES_LIST = $(SYS_CONFIG_C) $(SYS_RO_VARS_C) $(V7_PATH)/v7.c

FS_FILES = $(wildcard $(SRC_PATH)/js/* $(SRC_PATH)/fs/*)

# Custom conf.json : by default, it is empty, so that the one from `fs` is
# used. NOTE: if the custom one is provided, the file should anyway be named
# `conf.json`
CONF_JSON ?= ""

# If custom conf.json was provided, use it
ifneq ($(CONF_JSON),"")
  # Note: instead of substituting one with another one, we separately remove
  # the old one, and add a new one, to make it work even if `fs` does not
  # contain `conf.json`.
  FS_FILES := $(subst $(SRC_PATH)/fs/conf.json,,$(FS_FILES))
  FS_FILES += $(CONF_JSON)
endif

.PHONY: all clean fs

define compile
$(vecho) "CC    $< -> $@"
$(Q) $(CC_WRAPPER) $(CC) -MD $(INCDIRS) $(CFLAGS) $1 -c $< -o $@
endef

all: $(BIN_DIR) $(BUILD_DIR) $(BIN_DIR)/$(OUTAPP) fs

include $(REPO_PATH)/fw/src/sys_config.mk

$(BIN_DIR) $(BUILD_DIR):
	$(vecho) MKDIR $@
	$(Q) mkdir -p $@

# This rule is for normal (pre-existing) sources from VPATH.
$(BUILD_DIR)/%.o: %.c $(GENFILES_FLAG)
	$(call compile,)

# This one is for generated sources in build directory.
$(BUILD_DIR)/%.o: $(BUILD_DIR)/%.c $(GENFILES_FLAG)
	$(call compile,)

$(BUILD_DIR)/mongoose.o: mongoose.c
	$(call compile,-DEXCLUDE_COMMON)

$(BUILD_DIR)/build_info.o: $(BUILD_INFO_C)
	$(call compile,)

# Common gathering point for all generated files.
# Except build info, which is special because it depends on objects.
$(GENFILES_FLAG): $(GENFILES_LIST)
	$(Q) touch $@

# Generate build info. Only regenerates if there are changes in objects.
include $(REPO_PATH)/common/scripts/build_info.mk

-include $(wildcard $(BUILD_DIR)/*.d)

$(V7_PATH)/v7.c:
	@make -C $(V7_PATH) v7.c

$(BIN_DIR)/$(OUTAPP): $(BIN_DIR) $(V7_PATH)/v7.c $(OBJS)
	@echo "LD $@"
	$(Q) $(CC_WRAPPER) $(CC) $(OBJS) $(LIBS) $(LDFLAGS) -o $@

# After file copy, change default HTTP port to 9080
fs: $(BIN_DIR) $(FS_FILES)
	@echo "MKFS $@"
	$(Q) cp $(FS_FILES) $(BIN_DIR)
	$(Q) perl -pi"" -e 's/"80"/"9080"/' $(BIN_DIR)/conf_sys_defaults.json

clean:
	$(Q) rm -rf $(BIN_DIR) $(BUILD_DIR)
